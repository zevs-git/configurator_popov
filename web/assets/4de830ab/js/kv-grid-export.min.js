/*!
 * @copyright Copyright &copy; Kartik Visweswaran, Krajee.com, 2013
 * @version 1.0.0
 *
 * Grid Export Validation Module for Yii's Gridview. Supports export of
 * grid data as CSV, HTML, or Excel.
 *
 * Author: Kartik Visweswaran
 * Copyright: 2013, Kartik Visweswaran, Krajee.com
 * For more JQuery plugins visit http://plugins.krajee.com
 * For more Yii related demos visit http://demos.krajee.com
 */(function(e){var t="<!DOCTYPE html>"+'<meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/>'+'<meta http-equiv="X-UA-Compatible" content="IE=edge;chrome=1"/>'+"{css}"+"<style>"+".kv-wrap{padding:20px;}"+".kv-align-center{text-align:center;}"+".kv-align-left{text-align:left;}"+".kv-align-right{text-align:right;}"+".kv-align-top{vertical-align:top!important;}"+".kv-align-bottom{vertical-align:bottom!important;}"+".kv-align-middle{vertical-align:middle!important;}"+".kv-page-summary{border-top:4px double #ddd;font-weight: bold;}"+".kv-table-footer{border-top:4px double #ddd;font-weight: bold;}"+".kv-table-caption{font-size:1.5em;padding:8px;border:1px solid #ddd;border-bottom:none;}"+"</style>"+'<body class="kv-wrap">'+"{data}"+"</body>";var n='<html xmlns:o="urn:schemas-microsoft-com:office:office" xmlns:x="urn:schemas-microsoft-com:office:excel"'+'xmlns="http://www.w3.org/TR/REC-html40">'+"<head>"+"{css}"+"<!--[if gte mso 9]>"+"<xml>"+"<x:ExcelWorkbook>"+"<x:ExcelWorksheets>"+"<x:ExcelWorksheet>"+"<x:Name>{worksheet}</x:Name>"+"<x:WorksheetOptions>"+"<x:DisplayGridlines/>"+"</x:WorksheetOptions>"+"</x:ExcelWorksheet>"+"</x:ExcelWorksheets>"+"</x:ExcelWorkbook>"+"</xml>"+"<![endif]-->"+"</head>"+"<body>"+"{data}"+"</body>"+"</html>";var r=function(t,n){this.$element=e(t);this.$grid=n.grid;this.$table=this.$grid.find("table");this.$form=this.$grid.find("form.kv-export-form");this.filename=n.filename;this.showHeader=n.showHeader;this.columns=n.showHeader?"td,th":"td";this.worksheet=n.worksheet;this.colDelimiter=n.colDelimiter;this.rowDelimiter=n.rowDelimiter;this.alertMsg=n.alertMsg;this.browserPopupsMsg=n.browserPopupsMsg;this.cssFile=n.cssFile;this.listen()};r.prototype={constructor:r,notify:function(){var e=this;var t=e.alertMsg.length?e.alertMsg:"",n=e.browserPopupsMsg.length?e.browserPopupsMsg:"",r="";if(t.length&&n.length){r=t+"\n\n"+n}else if(!t.length&&n.length){r=n}else if(t.length&&!n.length){r=t}else{return}alert(r)},listen:function(){var e=this;if(e.$element.hasClass("export-csv")){e.$element.on("click",function(t){e.notify();e.exportTEXT("csv");t.preventDefault()})}else if(e.$element.hasClass("export-txt")){e.$element.on("click",function(t){e.notify();e.exportTEXT("txt");t.preventDefault()})}else if(e.$element.hasClass("export-html")){e.$element.on("click",function(t){e.notify();e.exportHTML();t.preventDefault()})}else if(e.$element.hasClass("export-xls")){e.$element.on("click",function(t){e.notify();e.exportEXCEL();t.preventDefault()})}},clean:function(){var e=this,t=e.$table;t.find("tr.filters").remove();t.find("th").removeAttr("rowspan");if(!e.showHeader){t.find("thead").remove()}if(!e.showPageSummary){t.find("tfoot.kv-page-summary").remove()}if(!e.showFooter){t.find("tfoot.kv-table-footer").remove()}if(!e.showCaption){t.find("kv-table-caption").remove()}return t},download:function(e,t){var n=this;n.$form.find('[name="export_filetype"]').val(e);n.$form.find('[name="export_filename"]').val(n.filename);n.$form.find('[name="export_content"]').val(t);n.$form.submit();n.$grid.yiiGridView("applyFilter")},exportHTML:function(){var n=this,r=n.clean();var i=n.cssFile&&n.cssFile.length?'<link href="'+n.cssFile+'" rel="stylesheet">':"";var s=t.replace("{css}",i).replace("{data}",e("<div />").html(r.clone()).html());n.download("html",s)},exportTEXT:function(t){var n=this,r=n.clean(),i=r.find("tr:has("+n.columns+")");var s=String.fromCharCode(11),o=String.fromCharCode(0);var u='"'+n.colDelimiter+'"',a='"'+n.rowDelimiter+'"';var f='"'+i.map(function(t,r){var i=e(r),o=i.find(n.columns);return o.map(function(t,n){var r=e(n),i=r.text();return i.replace('"','""')}).get().join(s)}).get().join(o).split(o).join(a).split(s).join(u)+'"';n.download(t,f)},exportEXCEL:function(){var t=this,r=t.clean();r.find("input").remove();var i=t.cssFile&&t.cssFile.length?'<link href="'+t.cssFile+'" rel="stylesheet">':"";var s=n.replace("{css}",i).replace("{worksheet}",t.worksheet).replace("{data}",e("<div />").html(r.clone()).html()).replace(/"/g,"'");t.download("xls",s)}};e.fn.gridexport=function(t){return this.each(function(){var n=e(this),i=n.data("gridexport");if(!i){n.data("gridexport",i=new r(this,t))}if(typeof t=="string"){i[t]()}})};e.fn.gridexport=function(t){var n=Array.apply(null,arguments);n.shift();return this.each(function(){var i=e(this),s=i.data("gridexport"),o=typeof t==="object"&&t;if(!s){i.data("gridexport",s=new r(this,e.extend({},e.fn.gridexport.defaults,o,e(this).data())))}if(typeof t==="string"){s[t].apply(s,n)}})};e.fn.gridexport.defaults={filename:"export",showHeader:true,showPageSummary:true,showFooter:true,showCaption:true,worksheet:"",colDelimiter:",",rowDelimiter:"\r\n",alertMsg:"",browserPopupsMsg:"",cssFile:""}})(window.jQuery)